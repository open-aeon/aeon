[English](./README.md)

# Aeon - 一个用 Rust 构建的 Kafka 兼容消息队列

Aeon 是一个从零开始、使用异步 Rust 构建的高性能、兼容 Kafka 协议的消息队列。项目旨在探索现代分布式消息系统的核心原理，其设计灵感来源于 Apache Kafka 和 Redpanda 等业界领先的平台。

**本项目当前版本为 `v0.1.0`，其核心是一个功能完备的单节点引擎。**

## 🌟 v0.1.0 版本亮点与特性

`v0.1.0` 版本提供了一个健壮的单节点消息代理（Broker），其核心优势在于协议的正确性、存储的高效性以及对消费组（Consumer Group）的完整实现。

*   **🚀 Kafka 协议兼容**: 完全兼容 Kafka 协议，允许使用任何标准的 Kafka 客户端（如 `rdkafka`、Java 客户端等）进行消息的生产和消费。
    *   通过 `build.rs` 构建脚本实现协议的自动化代码生成。该脚本能够解析 Kafka 官方的 JSON 协议规范，自动生成相应的 Rust 结构体及序列化/反序列化逻辑，确保了协议的正确性并易于后续升级。

*   **💾 高性能日志存储引擎**:
    *   基于内存映射文件（`mmap`）构建，实现了零拷贝读取和高吞吐量写入。
    *   采用分段式日志设计（Segmented Log），每个主题分区由多个日志段文件构成。
    *   为每个日志段实现了稀疏内存中索引（Sparse Index），允许在无需将整个索引加载到内存的情况下，快速定位消息偏移量。

*   **🔄 完整的消费组实现**:
    *   在 Broker 端实现了功能完整的组协调器（Group Coordinator），用于管理消费组。
    *   支持动态分区重平衡（Rebalance），当消费者加入或离开消费组时，分区会自动重新分配。
    *   完整处理了 Kafka 消费组的协议套件（`FindCoordinator`, `JoinGroup`, `SyncGroup`, `Heartbeat`, `OffsetCommit/Fetch`）。

*   **⚙️ 异步化架构**:
    *   完全基于 `tokio` 构建，利用 Rust 的 `async/await` 特性实现高并发和高效的 I/O 处理。
    *   每一个消费组都由一个独立的异步任务（Actor 模型）进行管理，确保了不同消费组间的隔离性和系统的可伸缩性。

## 🏛️ 架构 (v0.1.0)

![Aeon 架构图](./assets/architecture.png)

Aeon `v0.1.0` 的单节点架构由以下几个关键组件构成：

1.  **TCP 服务器 (`server`)**: Broker 的入口。它负责监听来自 Kafka 客户端的连接，将原始字节流解码为 Kafka 请求帧（`Request Frame`），并传递给请求处理器。
2.  **请求处理器 (`handler`)**: 解析请求类型，并将其分发给 `Broker` 中相应的业务逻辑。处理完成后，它会将响应（`Response`）编码并发送回客户端。
3.  **Broker (`broker`)**: 系统的核心协调组件，负责管理主题、分区和消费组的元数据。
4.  **组协调器 (`coordinator`)**: 管理消费组的完整生命周期。每个消费组都由一个独立的异步任务处理，响应成员加入、心跳等事件，并触发重平衡。
5.  **存储引擎 (`storage`)**: 持久化层。负责管理每个主题分区在磁盘上的物理日志段。
    *   **日志 (`log`)**: 主题分区有序消息序列的逻辑表示。
    *   **日志段 (`segment`)**: 磁盘上的单个日志文件，由 `mmap` 支持。包含了实际的 `RecordBatch` 数据。
    *   **索引 (`index`)**: 每个日志段对应的稀疏索引文件，用于映射消息偏移量到其在日志段文件中的物理字节位置。

## 🚀 快速上手

目前，运行和体验 Aeon 的主要方式是通过集成测试。

1.  **克隆仓库**:
    ```bash
    git clone https://github.com/your-username/aeon.git
    cd aeon
    ```

2.  **运行集成测试**:
    该测试将会启动一个 Broker，创建一个主题，生产 10 条消息，并通过一个消费组消费它们。
    ```bash
    cargo test --test consumer_group_test
    ```

## 🗺️ 路线图

*   **v0.1.0**: 单节点核心 (✅)
*   **v0.2.0**: 持久化与恢复 (进行中)
    *   协调器状态快照。
    *   存储引擎的崩溃恢复机制。
*   **v0.3.0**: 分布式能力
    *   实现 Raft 多数派共识算法用于元数据管理。
    *   支持多 Broker 集群。
