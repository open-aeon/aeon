[English](./README.md)

# Aeon - 一个用 Rust 构建的 Kafka 兼容消息队列

Aeon 是一个从零开始、使用异步 Rust 构建的高性能、兼容 Kafka 协议的消息队列。项目旨在探索现代分布式消息系统的核心原理，其设计灵感来源于 Apache Kafka 和 Redpanda 等业界领先的平台。

**本项目当前版本为 `v0.1.0`，其核心是一个功能完备的单节点引擎。**

## 🌟 亮点与特性

`v0.1.0` 版本提供了一个健壮的单节点消息代理（Broker），其核心在于深度的工程解决方案与协议的正确性。

*   **🚀 通过代码自动生成实现 Kafka 协议兼容**:
    *   为避免手动实现协议的繁琐和易错，整个 Kafka 协议层代码是**自动化生成**的。
    *   通过 `build.rs` 构建脚本解析 Kafka 官方的 JSON 协议规范，并利用过程宏（`aeon-protocol-macro`）自动生成所有请求/响应的结构体，及其版本兼容的序列化（`Encode`）和反序列化（`Decode`）逻辑。


*   **🔄 完整的消费组及重平衡实现**:
    *   实现了一个功能完整的**组协调器（Group Coordinator）**，并以独立的异步 Actor 模式运行，负责管理消费者的整个生命周期。这通常是消息代理中最复杂的部分。
    *   正确地处理了 Kafka 消费组的全套协议：`FindCoordinator`, `JoinGroup`, `SyncGroup`, `Heartbeat`, 以及 `OffsetCommit/Fetch`。
    *   支持动态分区重平衡，当消费组内成员发生变化时，能确保分区被重新正确分配，保证消息不丢失且消费负载均衡。

*   **💾 高性能 I/O 与存储引擎**:
    *   存储引擎基于**内存映射文件（`mmap`）** 构建，以实现高吞吐的写入和**零拷贝（zero-copy）**读取，最大化地减少了内核态/用户态的上下文切换开销。
    *   实现了**分段式日志（segmented log）**设计，并辅以**稀疏内存中索引（sparse in-memory index）**，在不消耗大量内存的前提下实现了高效的偏移量查找。

*   **✅ 通过标准客户端进行端到端测试**:
    *   项目的正确性和兼容性由一个综合性的集成测试套件来保证。
    *   该测试套件使用标准的 `rdkafka` (librdkafka) Rust 客户端，完整地执行了“生产-消费”全流程，证明了 Aeon 能够与现有的 Kafka 生态无缝协作。

## 🏛️ 架构 (v0.1.0)

![Aeon 架构图](./assets/architecture.png)

Aeon `v0.1.0` 的单节点架构由以下几个关键组件构成：

1.  **TCP 服务器 (`server`)**: Broker 的入口。它负责监听来自 Kafka 客户端的连接，将原始字节流解码为 Kafka 请求帧（`Request Frame`），并传递给请求处理器。
2.  **请求处理器 (`handler`)**: 解析请求类型，并将其分发给 `Broker` 中相应的业务逻辑。处理完成后，它会将响应（`Response`）编码并发送回客户端。
3.  **Broker (`broker`)**: 系统的核心协调组件，负责管理主题、分区和消费组的元数据。
4.  **组协调器 (`coordinator`)**: 管理消费组的完整生命周期。每个消费组都由一个独立的异步任务处理，响应成员加入、心跳等事件，并触发重平衡。
5.  **存储引擎 (`storage`)**: 持久化层。负责管理每个主题分区在磁盘上的物理日志段。
    *   **日志 (`log`)**: 主题分区有序消息序列的逻辑表示。
    *   **日志段 (`segment`)**: 磁盘上的单个日志文件，由 `mmap` 支持。包含了实际的 `RecordBatch` 数据。
    *   **索引 (`index`)**: 每个日志段对应的稀疏索引文件，用于映射消息偏移量到其在日志段文件中的物理字节位置。

## 🚀 快速上手

目前，运行和体验 Aeon 的主要方式是通过集成测试。

1.  **克隆仓库**:
    ```bash
    git clone https://github.com/your-username/aeon.git
    cd aeon
    ```

2.  **运行集成测试**:
    该测试将会启动一个 Broker，创建一个主题，生产 10 条消息，并通过一个消费组消费它们。
    ```bash
    cargo test --test consumer_group_test
    ```

## 🗺️ 路线图

Aeon 的未来规划是从当前的单节点核心，逐步演进为一个功能完备、分布式、云原生的消息平台。

*   **v0.1.0**: 单节点核心 (✅ 已完成)

*   **v0.2.0**: 功能完备与性能验证
    *   实现完整的 Kafka 功能兼容，包括主题管理、时间戳、事务等高级特性。
    *   进行全面的性能基准测试与调优，建立性能基线。

*   **v0.3.0**: 分布式架构
    *   采用纯 Raft 架构，将 Aeon 从单节点演进为高可用的多节点分布式集群，实现元数据管理。

*   **v0.4.0**: 企业级特性
    *   **安全**: 实现 TLS 传输层加密，保障数据安全。
    *   **监控**: 集成 Prometheus 指标，提供深度可观测性。
    *   **管理**: 实现 `DescribeCluster`, `DescribeConfigs`, `AlterConfigs` 等高级管理 API。

*   **未来探索**:
    *   **Linux I/O 优化**: 探索 `io_uring`、`kTLS` 等前沿技术，在 Linux 环境下提供极致性能。
    *   **云原生特性**: 引入分层存储，以实现更经济高效的长期数据保留策略。
    *   **可扩展性**: 添加 WASM (WebAssembly) 支持，以实现简化、高效的代理内流处理能力。
